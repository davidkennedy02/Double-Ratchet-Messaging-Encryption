name: Secure Messenger DevSecOps

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  security-events: write # Required to upload security results to GitHub Security tab

jobs:
  # ------------------------------------------------------------------
  # GATE 1: SECRET SCANNING
  # Detects private keys (like serverkey.pem) or passwords in code
  # ------------------------------------------------------------------
  secret-scan:
    name: 1. Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Failure here means a secret was found in the commit history

  # ------------------------------------------------------------------
  # GATE 2: STATIC ANALYSIS (SAST) & DEPENDENCIES (SCA)
  # Checks Python code quality and vulnerable libraries
  # ------------------------------------------------------------------
  code-security:
    name: 2. Code & Dependency Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety flake8
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # Linter: Enforce code style standards
      - name: Lint with Flake8
        run: |
          # Stop build if there are Python syntax errors
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      # SCA: Check for known vulnerabilities in requirements.txt
      - name: Dependency Vulnerability Scan (Safety)
        run: |
          safety check -r requirements.txt --continue-on-error
        # Note: Removed --full-report for brevity in logs

      # SAST: Scan python code for security flaws (e.g., hardcoded passwords)
      - name: Python Security Scan (Bandit)
        run: |
          bandit -r . -ll -ii -f sarif -o bandit-results.sarif

      # Upload SAST results to GitHub Security Tab
      - name: Upload Analysis Results
        uses: github/codeql-action/upload-sarif@v4
        if: always() # Run even if Bandit found issues
        with:
          sarif_file: bandit-results.sarif
          category: bandit

  # ------------------------------------------------------------------
  # GATE 3: CONTAINER SECURITY
  # Builds the image and scans it for OS vulnerabilities
  # ------------------------------------------------------------------
  container-security:
    name: 3. Container Vulnerability Scan
    runs-on: ubuntu-latest
    needs: [secret-scan, code-security] # Only run if code checks pass
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build the image but don't push it yet
      - name: Build Server Image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.server
          push: false
          tags: secure-messenger:test
          outputs: type=docker,dest=/tmp/server-image.tar

      # Scan the built image with Trivy
      - name: Trivy Image Vulnerability Scanner
        uses: aquasecurity/trivy-action@0.29.0
        with:
          input: /tmp/server-image.tar
          format: 'table'
          exit-code: '1' # Fail pipeline on Critical/High vulnerabilities
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'